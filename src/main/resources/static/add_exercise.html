<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gym Workout Insight - Log Workout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<div class="container py-4">
    <h1 class="mb-4">Log Workout</h1>

    <form id="workoutForm" class="mb-4">
        <!-- Date & Time -->
        <div class="mb-3">
            <label for="workoutDate" class="form-label">Date</label>
            <input type="date" id="workoutDate" class="form-control" required />
        </div>

        <div class="mb-3">
            <label for="workoutTime" class="form-label">Time</label>
            <input type="time" id="workoutTime" class="form-control" required />
        </div>

        <h4>Add Exercises</h4>
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="exerciseName" class="form-label">Exercise Name</label>
                <input type="text" id="exerciseName" class="form-control" placeholder="e.g., Push Ups or Plank" />
            </div>
            <div class="col-md-1">
                <label for="sets" class="form-label">Sets</label>
                <input type="number" min="0" id="sets" class="form-control" />
            </div>
            <div class="col-md-1">
                <label for="reps" class="form-label">Reps</label>
                <input type="number" min="0" id="reps" class="form-control" />
            </div>
            <div class="col-md-2">
                <label for="weight" class="form-label">Weight (kg)</label>
                <input type="number" min="0" step="0.1" id="weight" class="form-control" />
            </div>
            <div class="col-md-2">
                <label for="duration" class="form-label">Duration (min)</label>
                <input type="number" min="0" step="1" id="duration" class="form-control" />
            </div>
            <div class="col-md-3">
                <button type="button" id="addExerciseBtn" class="btn btn-primary w-100">Add Exercise</button>
            </div>
        </div>

        <div class="mt-4">
            <h5>Exercises Added</h5>
            <table class="table table-striped" id="exercisesTable" style="display:none;">
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Sets</th>
                    <th>Reps</th>
                    <th>Weight (kg)</th>
                    <th>Duration</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="exercisesBody"></tbody>
            </table>
        </div>

        <button type="submit" class="btn btn-success mt-3">Finish &amp; Get Insight</button>
    </form>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center my-3" style="display:none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- AI Feedback -->
    <div id="feedback" class="alert alert-info" style="display:none;"></div>
</div>

<!-- Markdown Renderer -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
    let exercises = [];

    const workoutDateInput = document.getElementById("workoutDate");
    const workoutTimeInput = document.getElementById("workoutTime");
    const exerciseNameInput = document.getElementById("exerciseName");
    const setsInput = document.getElementById("sets");
    const repsInput = document.getElementById("reps");
    const weightInput = document.getElementById("weight");
    const durationInput = document.getElementById("duration");
    const addExerciseBtn = document.getElementById("addExerciseBtn");
    const exercisesTable = document.getElementById("exercisesTable");
    const exercisesBody = document.getElementById("exercisesBody");
    const workoutForm = document.getElementById("workoutForm");
    const feedbackDiv = document.getElementById("feedback");
    const loadingSpinner = document.getElementById("loadingSpinner");

    const showLoading = () => loadingSpinner.style.display = "block";
    const hideLoading = () => loadingSpinner.style.display = "none";

    addExerciseBtn.addEventListener("click", () => {
      let name = exerciseNameInput.value.trim();
      let sets = parseInt(setsInput.value);
      let reps = parseInt(repsInput.value);
      let weight = parseFloat(weightInput.value);
      let duration = parseInt(durationInput.value);

      if (!name) {
        alert("Exercise name is required.");
        return;
      }

      // Must have either sets+reps or duration
      if ((!(sets && reps) || sets < 1 || reps < 1) && (!duration || duration < 1)) {
        alert("Enter sets+reps OR duration in minutes.");
        return;
      }

      const exercise = { name };
      if (duration && duration > 0) {
        // Timed exercise
        exercise.duration = duration;
        exercise.sets = 0;
        exercise.reps = 0;
        exercise.weight = 0;
      } else {
        // Reps-based exercise
        exercise.sets = sets;
        exercise.reps = reps;
        exercise.weight = isNaN(weight) ? 0 : weight;
        exercise.duration = 0;
      }

      exercises.push(exercise);
      renderExercises();

      // Clear form inputs for next entry
      exerciseNameInput.value = "";
      setsInput.value = "";
      repsInput.value = "";
      weightInput.value = "";
      durationInput.value = "";
    });

    function renderExercises() {
      exercisesBody.innerHTML = "";
      if (exercises.length === 0) {
        exercisesTable.style.display = "none";
        return;
      }
      exercisesTable.style.display = "table";
      exercises.forEach((ex, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${ex.name}</td>
          <td>${ex.sets || ""}</td>
          <td>${ex.reps || ""}</td>
          <td>${ex.weight ? ex.weight.toFixed(1) : ""}</td>
          <td>${ex.duration && ex.duration > 0 ? ex.duration + " min" : ""}</td>
          <td><button class="btn btn-sm btn-danger" data-index="${i}">Remove</button></td>
        `;
        exercisesBody.appendChild(tr);
      });

      // Attach remove listeners
      document.querySelectorAll("#exercisesBody button").forEach(btn =>
        btn.addEventListener("click", e => {
          const idx = parseInt(e.target.getAttribute("data-index"));
          exercises.splice(idx, 1);
          renderExercises();
        })
      );
    }

    workoutForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (exercises.length === 0) {
        alert("Please add at least one exercise before submitting.");
        return;
      }

      const date = workoutDateInput.value;
      const time = workoutTimeInput.value;
      if (!date || !time) {
        alert("Please select both date and time.");
        return;
      }

      const dateTime = date + " " + time;

      try {
        showLoading();
        // Save workout
        const workoutResponse = await fetch("/workout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ date: dateTime, exercises }),
        });
        if (!workoutResponse.ok) throw new Error("Failed to log workout.");
        const workoutData = await workoutResponse.json();

        // Get AI insight
        const insightResponse = await fetch("/insight", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ workoutId: workoutData.id }),
        });
        if (!insightResponse.ok) throw new Error("Failed to get insight.");
        const insightData = await insightResponse.json();

        // Render markdown as HTML
        feedbackDiv.innerHTML = `<strong>AI Feedback:</strong><br>${marked.parse(insightData.insight || "")}`;
        feedbackDiv.style.display = "block";

        // Reset form
        exercises = [];
        renderExercises();
        workoutDateInput.value = "";
        workoutTimeInput.value = "";
      } catch (err) {
        alert(err.message || "Error while submitting workout.");
      } finally {
        hideLoading();
      }
    });
</script>
</body>
</html>
